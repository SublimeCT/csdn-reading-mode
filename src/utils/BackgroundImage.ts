import { Toolkit } from "../utils/Toolkit"
import { config } from "../State"
import { GM_deleteValue, GM_getValue, GM_listValues, GM_setValue } from "$"
import type { UploadFileInfo } from "naive-ui"
// import ImageWorker from '@/utils/Image.worker?worker'
import type { CustomRequestOptions, SettledFileInfo } from "naive-ui/es/upload/src/interface"
import { reactive } from "vue"
import { DB, DBTable } from "./AppStorage"

export class BackgroundImage {
  /** çˆ¬åˆ°çš„æ‰€æœ‰ç°åœ¨å¯è®¿é—®çš„èƒŒæ™¯å›¾ID */
  static readonly IMG_CATEGORYS: Record<string, Array<number>> = { "çƒ­é—¨": [887, 886, 883, 882, 881, 880, 879, 878, 877, 876, 874, 875, 872, 873, 859, 832, 833, 834, 827, 828, 829, 830, 831, 817, 818, 819, 820, 821, 805, 806, 807, 808, 809, 810, 811, 812, 813, 814, 815, 816, 796, 797, 798, 799, 800, 801, 802, 803, 804, 776, 777, 778, 781, 784, 765, 767, 768, 766, 611, 610, 608, 720], "å†’é™©å²›2": [860, 861, 862, 863, 864, 865, 866, 867, 868, 869, 870, 871], "å®ˆæœ›å…ˆé”‹": [835, 836, 837, 838, 839, 840, 841, 842, 843, 844, 845, 846], "é­”å…½ä¸–ç•Œ": [721, 722, 723, 724, 725, 726, 727, 728, 729, 730, 731, 732], "ç‚‰çŸ³ä¼ è¯´": [733, 734, 735, 736, 737, 738, 739, 740, 741, 742, 743, 744], "é£æš´è‹±é›„": [660, 661, 662, 663, 664, 665, 666, 667, 668, 669, 670, 671], "æš—é»‘ç ´åç¥â…¢": [672, 673, 674, 675, 676, 677, 678, 679, 680, 681, 682, 683], "æ˜Ÿé™…äº‰éœ¸II": [684, 685, 686, 687, 688, 689, 690, 691, 692, 693, 694, 695], "å†·å…”": [749, 750, 751, 752, 753, 754, 755, 756, 757, 758, 759, 760], "é˜¿ç‹¸": [521, 114, 523, 524, 525, 526, 527, 528, 529, 530, 531, 532], "ç‚®ç‚®å…µ": [540, 534, 535, 536, 537, 538, 539, 533, 541, 542, 543, 544], "æ—å¿ƒå¦‚": [437, 438, 440, 439, 441, 443, 447, 444, 445, 446, 442, 448], "éƒ‘çˆ½": [509, 510, 511, 512, 515, 514, 513, 516, 517, 518, 519, 520], "æˆšè–‡": [449, 456, 451, 452, 453, 454, 455, 450, 457, 459, 458, 460], "ä½Ÿä¸½å¨…": [485, 486, 490, 488, 489, 487, 491, 492, 493, 494, 495, 496], "Angelababy": [400, 401, 402, 403, 407, 405, 406, 410, 404, 409, 408, 411], "å”å«£": [473, 474, 475, 482, 480, 478, 479, 477, 476, 481, 483, 484], "æå†°å†°": [424, 425, 427, 430, 426, 429, 428, 431, 432, 433, 434, 435], "é«˜åœ†åœ†": [412, 413, 418, 415, 416, 417, 414, 419, 420, 421, 422, 423], "å­™ä¿ª": [461, 462, 463, 464, 471, 466, 468, 467, 469, 470, 465, 472], "å§šæ™¨": [497, 498, 499, 506, 502, 501, 503, 504, 505, 507, 500, 508], "æ¨å¹‚": [200, 201, 202, 203, 204, 205, 206, 207, 208, 209, 210, 211], "åˆ˜è¯—è¯—": [273, 274, 275, 276, 277, 278, 279, 280, 281, 282, 283], "èƒ¡æ­Œ": [260, 261, 262, 263, 628, 629, 630, 631, 268, 269, 270, 271], "é‚“ç´«æ£‹": [320, 321, 322, 323, 324, 325, 326, 327, 328, 329, 330, 331], "èµµä¸½é¢–": [249, 2481, 250, 251, 252, 253, 254, 255, 256, 257, 258, 259], "é©¬å¤©å®‡": [284, 285, 286, 287, 288, 289, 290, 291, 292, 293, 294, 295], "é™ˆæ™“": [233, 225, 226, 227, 228, 229, 230, 231, 232, 224, 234, 235], "é™ˆä¼Ÿéœ†": [308, 309, 310, 311, 312, 313, 314, 315, 316, 317, 318, 319], "æŸ³å²©": [236, 2371, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247], "å´å¥‡éš†": [297, 298, 299, 300, 301, 302, 304, 296, 305, 306, 307], "é£æ™¯": [822, 823, 824, 825, 826, 54, 62, 5, 37, 115, 116, 117, 118, 120, 122, 123, 49, 25, 121, 26, 43, 45, 48, 51, 70, 4, 10, 11, 17, 23, 6, 28, 38, 16, 31, 42, 163, 164, 165, 166, 167, 168, 170, 171, 172, 174, 175, 177, 178, 179, 180, 181, 182, 184, 185, 186, 69, 57, 13, 67], "ç®€çº¦": [12, 111, 114, 53, 27, 33, 41, 35, 2, 14, 44, 21, 36, 8, 150, 125, 1, 169, 173, 176, 183, 46, 61, 47, 52, 64, 24, 58, 18, 59, 55, 9, 20], "å°æ¸…æ–°": [74, 71, 113, 119, 124, 29, 65, 32, 34, 39, 40, 50, 60, 73, 30, 63, 126, 128, 66, 19, 112, 22, 68, 7, 15, 3, 56] }
  /** æ¯å¼ å›¾ç‰‡çš„åç§° */
  static readonly IMG_MAP: Record<number, string> = { "1": "åŸé‡ å…¨æ™¯å›¾ç‰‡", "2": "é“¶æ±‰è¿¢è¿¢ å…¨æ™¯å›¾ç‰‡", "3": "ç´«è‰²éƒé‡‘é¦™ ç™¾åº¦ç›¸å†Œ", "4": "é£ç€‘å¦‚ç»ƒ å…¨æ™¯å›¾ç‰‡", "5": "æ¢¦é‡Œæ°´ä¹¡ æ¢æ‘„å°å­", "6": "é•¿å¤©ä¸€è‰² å…¨æ™¯å›¾ç‰‡", "7": "æ˜¥æ„æµ“ sprint207", "8": "æš®è‰²å››åˆ æ¢æ‘„å°å­", "9": "å‡ºæ°´èŠ™è“‰ æ¢æ‘„å°å­", "10": "å£ç«‹åƒä» å…¨æ™¯å›¾ç‰‡", "11": "å»Šæ¡¥é—æ¢¦ æ¢æ‘„å°å­", "12": "å¯¥è½æ˜Ÿæ²³ å…¨æ™¯å›¾ç‰‡", "13": "å±‚æ—å°½æŸ“ å…¨æ™¯å›¾ç‰‡", "14": "æ™¨æ›¦ æ¢æ‘„å°å­", "15": "æ—©æ¢…äº‰æ˜¥ æ¢æ‘„å°å­", "16": "åƒå±±é›ª åˆ˜éœ„", "17": "æµ·ä¹‹æ¢¦ å…¨æ™¯å›¾ç‰‡", "18": "ç™½è‰²é£ç¾½ sprint207", "19": "åœ¨è·¯ä¸Š jesse2young", "20": "é”¦é²¤ sprint207", "21": "é›¨å¤œ yunxiaoqian", "22": "æ°´å¢¨æ±Ÿå— æˆˆæ–¯æ‹‰918", "23": "åŸå¸‚ä¹‹å…‰ æˆˆæ–¯æ‹‰918", "24": "ä¸‰å¶è‰ wanzathe", "25": " å…¨æ™¯å›¾ç‰‡", "26": " å…¨æ™¯å›¾ç‰‡", "27": " å…¨æ™¯å›¾ç‰‡", "28": " å…¨æ™¯å›¾ç‰‡", "29": " å…¨æ™¯å›¾ç‰‡", "30": " å…¨æ™¯å›¾ç‰‡", "31": " å…¨æ™¯å›¾ç‰‡", "32": " å…¨æ™¯å›¾ç‰‡", "33": " å…¨æ™¯å›¾ç‰‡", "34": " å…¨æ™¯å›¾ç‰‡", "35": " å…¨æ™¯å›¾ç‰‡", "36": " å…¨æ™¯å›¾ç‰‡", "37": " å…¨æ™¯å›¾ç‰‡", "38": " å…¨æ™¯å›¾ç‰‡", "39": " å…¨æ™¯å›¾ç‰‡", "40": " å…¨æ™¯å›¾ç‰‡", "41": " å…¨æ™¯å›¾ç‰‡", "42": " å…¨æ™¯å›¾ç‰‡", "43": " å…¨æ™¯å›¾ç‰‡", "44": " å…¨æ™¯å›¾ç‰‡", "45": " å…¨æ™¯å›¾ç‰‡", "46": " å…¨æ™¯å›¾ç‰‡", "47": " å…¨æ™¯å›¾ç‰‡", "48": " å…¨æ™¯å›¾ç‰‡", "49": " å…¨æ™¯å›¾ç‰‡", "50": " å…¨æ™¯å›¾ç‰‡", "51": " å…¨æ™¯å›¾ç‰‡", "52": " å…¨æ™¯å›¾ç‰‡", "53": " ranklau", "54": " silsnow", "55": " weifengqingyu", "56": " å¼ äº‘æ´01", "57": " tiffanywangbei", "58": " ying_ok_delang", "59": " sherry_dundun", "60": " æºå½¢æ¯•éœ²", "61": " è·¯ç’", "62": " richard-wang", "63": " æºå½¢æ¯•éœ²", "64": " åœ£åè‹¥ç‘Ÿ", "65": " ç±³å£¹æ˜ ç”»", "66": " ç±³å£¹æ˜ ç”»", "67": " è·¯ç’", "68": " è·¯ç’", "69": " æ¯›å˜‰æ–‡", "70": " richard-wang", "71": " fish,èƒ¡å­é±¼", "73": " fish,èƒ¡å­é±¼", "74": " fish,èƒ¡å­é±¼", "111": " å…¨æ™¯å›¾ç‰‡", "112": " fishï¼Œèƒ¡å­é±¼", "113": " fishï¼Œèƒ¡å­é±¼", "114": " å…¨æ™¯å›¾ç‰‡", "115": " å½¼å²¸Claire", "116": " è½ç»ªçº·é£", "117": " é­”ç¥å’’", "118": " lemonchen07", "119": " å†³æ˜", "120": " é•¿è€äº®", "121": " è“æœˆç©è½¬è¥¿éƒ¨", "122": " å°pie", "123": " woodfishbbi", "124": " æ—©å·", "125": "æ³¢æ¶›æ±¹æ¶Œ å…¨æ™¯", "126": "ç«è½¦é£é©° å…¨æ™¯", "128": "æ¼”å”±ä¼š å…¨æ™¯", "150": "æ¿€æƒ…ä¸–ç•Œæ¯ ", "163": " shenmishashou", "164": " æˆ‘å«å­Ÿå¤•", "165": " ç©·æ¸¸æ™“æ˜", "166": " 1024å°è™ç‰™", "167": " shenmishashou", "168": " shenmishashou", "169": " 0535xiaoyudi", "170": " ç©·æ¸¸æ™“æ˜", "171": " è¥¿è¥¿é‡Œç©ä¸åœ", "172": " è¥¿è¥¿é‡Œç©ä¸åœ", "173": " 1024å°è™ç‰™", "174": " shenmishashou", "175": " ç©·æ¸¸æ™“æ˜", "176": " 1024å°è™ç‰™", "177": " æˆ‘å«å­Ÿå¤•", "178": " 1024å°è™ç‰™", "179": " shenmishashou", "180": " è¥¿è¥¿é‡Œç©ä¸åœ", "181": " æˆ‘å«å­Ÿå¤•", "182": " è“è‰²å‘“è¯­", "183": " è¥¿è¥¿é‡Œç©ä¸åœ", "184": " è¥¿è¥¿é‡Œç©ä¸åœ", "185": " æˆ‘å«å­Ÿå¤•", "186": " è¥¿è¥¿é‡Œç©ä¸åœ", "200": "æ¨å¹‚0", "201": "æ¨å¹‚1", "202": "æ¨å¹‚2", "203": "æ¨å¹‚3", "204": "æ¨å¹‚4", "205": "æ¨å¹‚5", "206": "æ¨å¹‚6", "207": "æ¨å¹‚7", "208": "æ¨å¹‚8", "209": "æ¨å¹‚9", "210": "æ¨å¹‚10", "211": "æ¨å¹‚11", "224": "é™ˆæ™“9", "225": "é™ˆæ™“1", "226": "é™ˆæ™“2", "227": "é™ˆæ™“3", "228": "é™ˆæ™“4", "229": "é™ˆæ™“5", "230": "é™ˆæ™“6", "231": "é™ˆæ™“7", "232": "é™ˆæ™“8", "233": "é™ˆæ™“0", "234": "é™ˆæ™“10", "235": "é™ˆæ™“11", "236": "æŸ³å²©0", "238": "æŸ³å²©2", "239": "æŸ³å²©3", "240": "æŸ³å²©4", "241": "æŸ³å²©5", "242": "æŸ³å²©6", "243": "æŸ³å²©7", "244": "æŸ³å²©8", "245": "æŸ³å²©9", "246": "æŸ³å²©10", "247": "æŸ³å²©11", "249": "èµµä¸½é¢–0", "250": "èµµä¸½é¢–2", "251": "èµµä¸½é¢–3", "252": "èµµä¸½é¢–4", "253": "èµµä¸½é¢–5", "254": "èµµä¸½é¢–6", "255": "èµµä¸½é¢–7", "256": "èµµä¸½é¢–8", "257": "èµµä¸½é¢–9", "258": "èµµä¸½é¢–10", "259": "èµµä¸½é¢–11", "260": "èƒ¡æ­Œ0", "261": "èƒ¡æ­Œ1", "262": "èƒ¡æ­Œ2", "263": "èƒ¡æ­Œ3", "268": "èƒ¡æ­Œ8", "269": "èƒ¡æ­Œ9", "270": "èƒ¡æ­Œ10", "271": "èƒ¡æ­Œ11", "273": "åˆ˜è¯—è¯—0", "274": "åˆ˜è¯—è¯—1", "275": "åˆ˜è¯—è¯—2", "276": "åˆ˜è¯—è¯—3", "277": "åˆ˜è¯—è¯—4", "278": "åˆ˜è¯—è¯—5", "279": "åˆ˜è¯—è¯—6", "280": "åˆ˜è¯—è¯—7", "281": "åˆ˜è¯—è¯—8", "282": "åˆ˜è¯—è¯—9", "283": "åˆ˜è¯—è¯—10", "284": "é©¬å¤©å®‡0", "285": "é©¬å¤©å®‡1", "286": "é©¬å¤©å®‡2", "287": "é©¬å¤©å®‡3", "288": "é©¬å¤©å®‡4", "289": "é©¬å¤©å®‡5", "290": "é©¬å¤©å®‡6", "291": "é©¬å¤©å®‡7", "292": "é©¬å¤©å®‡8", "293": "é©¬å¤©å®‡9", "294": "é©¬å¤©å®‡10", "295": "é©¬å¤©å®‡11", "296": "å´å¥‡éš†7", "297": "å´å¥‡éš†0", "298": "å´å¥‡éš†1", "299": "å´å¥‡éš†2", "300": "å´å¥‡éš†3", "301": "å´å¥‡éš†4", "302": "å´å¥‡éš†5", "304": "å´å¥‡éš†6", "305": "å´å¥‡éš†8", "306": "å´å¥‡éš†9", "307": "å´å¥‡éš†10", "308": "é™ˆä¼Ÿéœ†0", "309": "é™ˆä¼Ÿéœ†1", "310": "é™ˆä¼Ÿéœ†2", "311": "é™ˆä¼Ÿéœ†3", "312": "é™ˆä¼Ÿéœ†4", "313": "é™ˆä¼Ÿéœ†5", "314": "é™ˆä¼Ÿéœ†6", "315": "é™ˆä¼Ÿéœ†7", "316": "é™ˆä¼Ÿéœ†8", "317": "é™ˆä¼Ÿéœ†9", "318": "é™ˆä¼Ÿéœ†10", "319": "é™ˆä¼Ÿéœ†11", "320": "é‚“ç´«æ£‹0", "321": "é‚“ç´«æ£‹1", "322": "é‚“ç´«æ£‹2", "323": "é‚“ç´«æ£‹3", "324": "é‚“ç´«æ£‹4", "325": "é‚“ç´«æ£‹5", "326": "é‚“ç´«æ£‹6", "327": "é‚“ç´«æ£‹7", "328": "é‚“ç´«æ£‹8", "329": "é‚“ç´«æ£‹9", "330": "é‚“ç´«æ£‹10", "331": "é‚“ç´«æ£‹11", "400": "Angelababy0", "401": "Angelababy1", "402": "Angelababy2", "403": "Angelababy3", "404": "Angelababy8", "405": "Angelababy5", "406": "Angelababy6", "407": "Angelababy4", "408": "Angelababy10", "409": "Angelababy9", "410": "Angelababy7", "411": "Angelababy11", "412": "é«˜åœ†åœ†0", "413": "é«˜åœ†åœ†1", "414": "é«˜åœ†åœ†6", "415": "é«˜åœ†åœ†3", "416": "é«˜åœ†åœ†4", "417": "é«˜åœ†åœ†5", "418": "é«˜åœ†åœ†2", "419": "é«˜åœ†åœ†7", "420": "é«˜åœ†åœ†8", "421": "é«˜åœ†åœ†9", "422": "é«˜åœ†åœ†10", "423": "é«˜åœ†åœ†11", "424": "æå†°å†°0", "425": "æå†°å†°1", "426": "æå†°å†°4", "427": "æå†°å†°2", "428": "æå†°å†°6", "429": "æå†°å†°5", "430": "æå†°å†°3", "431": "æå†°å†°7", "432": "æå†°å†°8", "433": "æå†°å†°9", "434": "æå†°å†°10", "435": "æå†°å†°11", "437": "æ—å¿ƒå¦‚0", "438": "æ—å¿ƒå¦‚1", "439": "æ—å¿ƒå¦‚3", "440": "æ—å¿ƒå¦‚2", "441": "æ—å¿ƒå¦‚4", "442": "æ—å¿ƒå¦‚10", "443": "æ—å¿ƒå¦‚5", "444": "æ—å¿ƒå¦‚7", "445": "æ—å¿ƒå¦‚8", "446": "æ—å¿ƒå¦‚9", "447": "æ—å¿ƒå¦‚6", "448": "æ—å¿ƒå¦‚11", "449": "æˆšè–‡0", "450": "æˆšè–‡7", "451": "æˆšè–‡2", "452": "æˆšè–‡3", "453": "æˆšè–‡4", "454": "æˆšè–‡5", "455": "æˆšè–‡6", "456": "æˆšè–‡1", "457": "æˆšè–‡8", "458": "æˆšè–‡10", "459": "æˆšè–‡9", "460": "æˆšè–‡11", "461": " é™ˆæ¼«", "462": "å­™ä¿ª1", "463": "å­™ä¿ª2", "464": "å­™ä¿ª3", "465": "å­™ä¿ª10", "466": "å­™ä¿ª5", "467": "å­™ä¿ª7", "468": " é™ˆæ¼«", "469": " é™ˆæ¼«", "470": "å­™ä¿ª9", "471": "å­™ä¿ª4", "472": "å­™ä¿ª11", "473": "å”å«£0", "474": "å”å«£1", "475": "å”å«£2", "476": "å”å«£8", "477": "å”å«£7", "478": "å”å«£5", "479": "å”å«£6", "480": "å”å«£4", "481": "å”å«£9", "482": "å”å«£3", "483": "å”å«£10", "484": "å”å«£11", "485": "ä½Ÿä¸½å¨…0", "486": "ä½Ÿä¸½å¨…1", "487": "ä½Ÿä¸½å¨…5", "488": "ä½Ÿä¸½å¨…3", "489": "ä½Ÿä¸½å¨…4", "490": "ä½Ÿä¸½å¨…2", "491": "ä½Ÿä¸½å¨…6", "492": "ä½Ÿä¸½å¨…7", "493": "ä½Ÿä¸½å¨…8", "494": "ä½Ÿä¸½å¨…9", "495": "ä½Ÿä¸½å¨…10", "496": "ä½Ÿä¸½å¨…11", "497": "å§šæ™¨0", "498": "å§šæ™¨1", "499": "å§šæ™¨2", "500": "å§šæ™¨10", "501": "å§šæ™¨5", "502": "å§šæ™¨4", "503": "å§šæ™¨6", "504": "å§šæ™¨7", "505": "å§šæ™¨8", "506": "å§šæ™¨3", "507": "å§šæ™¨9", "508": "å§šæ™¨11", "509": "éƒ‘çˆ½0", "510": "éƒ‘çˆ½1", "511": "éƒ‘çˆ½2", "512": "éƒ‘çˆ½3", "513": "éƒ‘çˆ½6", "514": "éƒ‘çˆ½5", "515": "éƒ‘çˆ½4", "516": "éƒ‘çˆ½7", "517": "éƒ‘çˆ½8", "518": "éƒ‘çˆ½9", "519": "éƒ‘çˆ½10", "520": "éƒ‘çˆ½11", "521": "é˜¿ç‹¸0", "523": "é˜¿ç‹¸2", "524": "é˜¿ç‹¸3", "525": "é˜¿ç‹¸4", "526": "é˜¿ç‹¸5", "527": "é˜¿ç‹¸6", "528": "é˜¿ç‹¸7", "529": "é˜¿ç‹¸8", "530": "é˜¿ç‹¸9", "531": "é˜¿ç‹¸10", "532": "é˜¿ç‹¸11", "533": "ç‚®ç‚®å…µ7", "534": "ç‚®ç‚®å…µ1", "535": "ç‚®ç‚®å…µ2", "536": "ç‚®ç‚®å…µ3", "537": "ç‚®ç‚®å…µ4", "538": "ç‚®ç‚®å…µ5", "539": "ç‚®ç‚®å…µ6", "540": "ç‚®ç‚®å…µ0", "541": "ç‚®ç‚®å…µ8", "542": "ç‚®ç‚®å…µ9", "543": "ç‚®ç‚®å…µ10", "544": "ç‚®ç‚®å…µ11", "608": "çƒ­é—¨60", "610": "çƒ­é—¨59", "611": "çƒ­é—¨58", "628": "èƒ¡æ­Œ4", "629": "èƒ¡æ­Œ5", "630": "èƒ¡æ­Œ6", "631": "èƒ¡æ­Œ7", "660": "é£æš´è‹±é›„0", "661": "é£æš´è‹±é›„1", "662": "é£æš´è‹±é›„2", "663": "é£æš´è‹±é›„3", "664": "é£æš´è‹±é›„4", "665": "é£æš´è‹±é›„5", "666": "é£æš´è‹±é›„6", "667": "é£æš´è‹±é›„7", "668": "é£æš´è‹±é›„8", "669": "é£æš´è‹±é›„9", "670": "é£æš´è‹±é›„10", "671": "é£æš´è‹±é›„11", "672": "æš—é»‘ç ´åç¥â…¢0", "673": "æš—é»‘ç ´åç¥â…¢1", "674": "æš—é»‘ç ´åç¥â…¢2", "675": "æš—é»‘ç ´åç¥â…¢3", "676": "æš—é»‘ç ´åç¥â…¢4", "677": "æš—é»‘ç ´åç¥â…¢5", "678": "æš—é»‘ç ´åç¥â…¢6", "679": "æš—é»‘ç ´åç¥â…¢7", "680": "æš—é»‘ç ´åç¥â…¢8", "681": "æš—é»‘ç ´åç¥â…¢9", "682": "æš—é»‘ç ´åç¥â…¢10", "683": "æš—é»‘ç ´åç¥â…¢11", "684": "æ˜Ÿé™…äº‰éœ¸II0", "685": "æ˜Ÿé™…äº‰éœ¸II1", "686": "æ˜Ÿé™…äº‰éœ¸II2", "687": "æ˜Ÿé™…äº‰éœ¸II3", "688": "æ˜Ÿé™…äº‰éœ¸II4", "689": "æ˜Ÿé™…äº‰éœ¸II5", "690": "æ˜Ÿé™…äº‰éœ¸II6", "691": "æ˜Ÿé™…äº‰éœ¸II7", "692": "æ˜Ÿé™…äº‰éœ¸II8", "693": "æ˜Ÿé™…äº‰éœ¸II9", "694": "æ˜Ÿé™…äº‰éœ¸II10", "695": "æ˜Ÿé™…äº‰éœ¸II11", "720": "çƒ­é—¨61", "721": "é­”å…½ä¸–ç•Œ0", "722": "é­”å…½ä¸–ç•Œ1", "723": "é­”å…½ä¸–ç•Œ2", "724": "é­”å…½ä¸–ç•Œ3", "725": "é­”å…½ä¸–ç•Œ4", "726": "é­”å…½ä¸–ç•Œ5", "727": "é­”å…½ä¸–ç•Œ6", "728": "é­”å…½ä¸–ç•Œ7", "729": "é­”å…½ä¸–ç•Œ8", "730": "é­”å…½ä¸–ç•Œ9", "731": "é­”å…½ä¸–ç•Œ10", "732": "é­”å…½ä¸–ç•Œ11", "733": "ç‚‰çŸ³ä¼ è¯´0", "734": "ç‚‰çŸ³ä¼ è¯´1", "735": "ç‚‰çŸ³ä¼ è¯´2", "736": "ç‚‰çŸ³ä¼ è¯´3", "737": "ç‚‰çŸ³ä¼ è¯´4", "738": "ç‚‰çŸ³ä¼ è¯´5", "739": "ç‚‰çŸ³ä¼ è¯´6", "740": "ç‚‰çŸ³ä¼ è¯´7", "741": "ç‚‰çŸ³ä¼ è¯´8", "742": "ç‚‰çŸ³ä¼ è¯´9", "743": "ç‚‰çŸ³ä¼ è¯´10", "744": "ç‚‰çŸ³ä¼ è¯´11", "749": "å†·å…”0", "750": "å†·å…”1", "751": "å†·å…”2", "752": "å†·å…”3", "753": "å†·å…”4", "754": "å†·å…”5", "755": "å†·å…”6", "756": "å†·å…”7", "757": "å†·å…”8", "758": "å†·å…”9", "759": "å†·å…”10", "760": "å†·å…”11", "765": "çƒ­é—¨54", "766": "çƒ­é—¨57", "767": "çƒ­é—¨55", "768": "çƒ­é—¨56", "776": " å…‰çº¿å½±ä¸š", "777": " å…‰çº¿å½±ä¸š", "778": " å…‰çº¿å½±ä¸š", "781": " å…‰çº¿å½±ä¸š", "784": " æ«æµ·å½±ä¸š", "796": " æ¬¢ç‘ä¸–çºª", "797": " æ¬¢ç‘ä¸–çºª", "798": " æ¬¢ç‘ä¸–çºª", "799": " æ¬¢ç‘ä¸–çºª", "800": " æ¬¢ç‘ä¸–çºª", "801": " æ¬¢ç‘ä¸–çºª", "802": " æ’ä¸šå½±ä¸š", "803": " å‘¨è¿…å·¥ä½œå®¤", "804": " åæ˜ ä¼ åª’", "805": " çˆ±å¥‡è‰º", "806": " çˆ±å¥‡è‰º", "807": " çˆ±å¥‡è‰º", "808": " ä¸–çºªé•¿é¾™", "809": " ä¸–çºªé•¿é¾™", "810": " ä¸–çºªé•¿é¾™", "811": " å˜‰æ˜ å½±ä¸š", "812": " æ—å¿ƒå¦‚å·¥ä½œå®¤", "813": " ç¯çƒå½±ä¸š", "814": " ç¯çƒå½±ä¸š", "815": " ç¯çƒå½±ä¸š", "816": " ç¯çƒå½±ä¸š", "817": " ç¯çƒå½±ä¸š", "818": " ç¯çƒå½±ä¸š", "819": " æ´¾æ‹‰è’™å½±ä¸š", "820": " æ´¾æ‹‰è’™å½±ä¸š", "821": " é»„å­éŸ¬å·¥ä½œå®¤", "822": " é«˜å“å›¾åƒ", "823": " é«˜å“å›¾åƒ", "824": " é«˜å“å›¾åƒ", "825": " é«˜å“å›¾åƒ", "826": " é«˜å“å›¾åƒ", "827": " çˆ±å¥‡è‰ºå½±ä¸š", "828": " çˆ±å¥‡è‰ºå½±ä¸š", "829": " ä¼˜é…·", "830": " åŸºç¾å½±ä¸š", "831": " åŸºç¾å½±ä¸š", "832": " é­”å¨æ˜ ç”»", "833": " äºšæ´²æ˜Ÿå…‰å¨±ä¹", "834": " å‘¨å†¬é›¨å·¥ä½œå®¤", "835": "å®ˆæœ›å…ˆé”‹0", "836": "å®ˆæœ›å…ˆé”‹1", "837": "å®ˆæœ›å…ˆé”‹2", "838": "å®ˆæœ›å…ˆé”‹3", "839": "å®ˆæœ›å…ˆé”‹4", "840": "å®ˆæœ›å…ˆé”‹5", "841": "å®ˆæœ›å…ˆé”‹6", "842": "å®ˆæœ›å…ˆé”‹7", "843": "å®ˆæœ›å…ˆé”‹8", "844": "å®ˆæœ›å…ˆé”‹9", "845": "å®ˆæœ›å…ˆé”‹10", "846": "å®ˆæœ›å…ˆé”‹11", "859": " è®°å¿†å¤§å¸ˆ", "860": "å†’é™©å²›20", "861": "å†’é™©å²›21", "862": "å†’é™©å²›22", "863": "å†’é™©å²›23", "864": "å†’é™©å²›24", "865": "å†’é™©å²›25", "866": "å†’é™©å²›26", "867": "å†’é™©å²›27", "868": "å†’é™©å²›28", "869": "å†’é™©å²›29", "870": "å†’é™©å²›210", "871": "å†’é™©å²›211", "872": " å¤©é¾™å…«éƒ¨", "873": " å¤©é¾™å…«éƒ¨", "874": " å˜å½¢é‡‘åˆšol", "875": " å˜å½¢é‡‘åˆšol", "876": " ä¸€å“èŠéº»ç‹", "877": " ä¸€å“èŠéº»ç‹", "878": " ä¸€å“èŠéº»ç‹", "879": " ä¸€å“èŠéº»ç‹", "880": " ä¸€å“èŠéº»ç‹", "881": " ä¸€å“èŠéº»ç‹", "882": " ç™½æ•¬äº­", "883": " å‰‘çµ", "886": " æœ€å¼ºnba", "887": " æœ€å¼ºnba", "2371": "æŸ³å²©1", "2481": "èµµä¸½é¢–1" }

  /** å½“å‰ image ID / è‡ªå®šä¹‰ url, ç”¨äºæ ‡è®°å½“å‰æ˜¾ç¤ºçš„å›¾ç‰‡ */
  static idOrUrl: string | number = ''

  /** è·å–æ–°çš„èƒŒæ™¯å›¾ç‰‡åœ°å€ */
  static getImgUrl() {
    const customUrl = config.customUrl
    let url = null
    let id = null
    if (customUrl) {
      url = `url(${customUrl})`
      BackgroundImage.idOrUrl = customUrl
    } else {
      const idList = BackgroundImage._getAllImgIdsByCategorys()
      const index = Toolkit.getRandomInterger(idList.length)
      id = idList[index]
      url = BackgroundImage._toBaiduUrl(id)
      BackgroundImage.idOrUrl = id || BackgroundImage._toBaiduUrl(id, false)
    }
    return url
  }

  /** è·å–ç”¨æˆ·æ‰€é€‰ç±»ç›®ä¸‹çš„æ‰€æœ‰å›¾ç‰‡ id */
  private static _getAllImgIdsByCategorys(): Array<number> {
    // æœªé€‰æ‹©æ—¶ä½¿ç”¨æ‰€æœ‰èƒŒæ™¯å›¾ç‰‡
    if (config.categorys.length === 0) return Object.keys(BackgroundImage.IMG_MAP).map(img => Number(img))
    const idList: Array<number> = []
    for (const categoryName in config.categorys) {
      if (Array.isArray(BackgroundImage.IMG_CATEGORYS[config.categorys[categoryName]])) {
        idList.push(...BackgroundImage.IMG_CATEGORYS[config.categorys[categoryName]])
      }
    }
    return idList
  }

  /**
   * è·å–ç™¾åº¦èƒŒæ™¯å›¾
   * @param id ç™¾åº¦èƒŒæ™¯å›¾ç‰‡ ID
   * @param cssWrap æ˜¯å¦ä½¿ç”¨ url() æ ¼å¼
   */
  private static  _toBaiduUrl(id: number, cssWrap: boolean = true) {
    const url = `https://ss2.bdstatic.com/lfoZeXSm1A5BphGlnYG/skin/${id}.jpg`
    return cssWrap ? `url(${url})` : url
  }

  /**
   * å½“å‰èƒŒæ™¯å›¾
   * @deprecated
   */
  static get currentUrl(): BackgroundImageInfo  {
    const result: BackgroundImageInfo = { url: '', name: '', category: '', html: '' }
    if (!BackgroundImage.idOrUrl) return result
    if (typeof BackgroundImage.idOrUrl === 'string') {
      result.url = BackgroundImage.idOrUrl
      result.name = 'è‡ªå®šä¹‰å›¾ç‰‡'
      result.html = `<span>è‡ªå®šä¹‰å›¾ç‰‡</span>`
    } else if (config.bgColor) {
      result.name = config.bgColor
      result.html = `<span>${config.bgColor}</span>`
    } else {
      result.url = BackgroundImage._toBaiduUrl(BackgroundImage.idOrUrl, false)
      for (const categoryName in BackgroundImage.IMG_CATEGORYS) {
        if (BackgroundImage.IMG_CATEGORYS[categoryName].includes(BackgroundImage.idOrUrl)) {
          result.category = categoryName
        }
      }
      result.name = BackgroundImage.IMG_MAP[BackgroundImage.idOrUrl]
      result.html = `<a class="link" target="_blank" href="${result.url}">${result.category ? '<' + result.category + '> ' : ''}${result.name}</a>`
    }
    return result
  }
}

/** èƒŒæ™¯æ ·å¼ä¿¡æ¯ */
export interface BackgroundImageInfo {
  url: string
  name: string
  category: string
  html: string
}

// export class ImageWorkerHandler {
//   /** æœ€å¤§çº¿ç¨‹æ•° */
//   static readonly WORKER_MAX_COUNT = Math.max(navigator.hardwareConcurrency, 4)
//   /** åˆ›å»ºç”¨äºå¤„ç†å›¾åƒçš„çº¿ç¨‹, ä¸ºäº†é˜²æ­¢è¶…è¿‡æµè§ˆå™¨é™åˆ¶, æœ€å¤§æ•°é‡ä¸º 4 */
//   static workers: Array<Worker> = []
//   // static workers = Array.from({ length:  }).map(() => new ImageWorker())
//   /** å½“å‰ä½¿ç”¨çš„çº¿ç¨‹ key */
//   static poolTaskCount: Array<number> = []
//   /** ä»çº¿ç¨‹æ± ä¸­åˆ›å»ºæˆ–è·å–çº¿ç¨‹ */
//   static getWorker() {
//     if (ImageWorkerHandler.workers.length >= ImageWorkerHandler.WORKER_MAX_COUNT) { // ä½¿ç”¨å·²æœ‰çº¿ç¨‹
//       let targetIndex = 0
//       for (let index = 0; index < ImageWorkerHandler.poolTaskCount.length; index++) {
//         if (index === 0) continue
//         if (ImageWorkerHandler.poolTaskCount[index] < ImageWorkerHandler.poolTaskCount[index - 1]) {
//           targetIndex = index
//           break
//         }
//       }
//       ImageWorkerHandler.poolTaskCount[targetIndex]++
//       return ImageWorkerHandler.workers[targetIndex]
//     } else { // åˆ›å»ºæ–°çº¿ç¨‹
//       const worker = new ImageWorker()
//       ImageWorkerHandler.workers.push(worker)
//       ImageWorkerHandler.poolTaskCount[ImageWorkerHandler.workers.length - 1] = 1
//       return worker
//     }
//   }
// }


/** ç”¨æˆ·è‡ªå®šä¹‰å›¾ç‰‡ */
export class CustomBackgroundImage {
  id: string = ''
  name: string = ''
  batchId?: string | null | undefined
  percentage?: number | null | undefined
  status: "pending" | "uploading" | "finished" | "removed" | "error" = 'pending'
  url?: string | null | undefined
  file?: File | null | undefined
  thumbnailUrl?: string | null | undefined
  type?: string | null | undefined
  fullPath?: string | null | undefined

  constructor(info: CustomBackgroundImage) {
    Object.assign(this, info)
  }

  /**
   * ä¸Šä¼ æ–‡ä»¶
   * 
   * å°†ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡ä¿å­˜åˆ° `indexeddb`, ä½†ç”±äºæµè§ˆå™¨çš„åŒæºç­–ç•¥, æ— æ³•é€‚ç”¨äºæ‰€æœ‰çš„æ–‡ç« é¡µé¢, å› ä¸ºåŸŸåå¯èƒ½æ˜¯ä¸ä¸€æ ·çš„, ä¾‹å¦‚:
   * 
   * - https://csdnnews.blog.csdn.net/article/details/133896968
   * - https://blog.csdn.net/weixin_44769612/article/details/130941960
   * 
   * ä½†å¦‚æœä½¿ç”¨ `Tampermonkey` çš„ `GM_setValue`, åœ¨å­˜å‚¨å¤§é‡æ•°æ®å, ä¼šå¯¼è‡´é¡µé¢æ‰€æœ‰çš„è„šæœ¬å¤±æ•ˆ ğŸ˜­
   * 
   * @param file ä¸Šä¼ çš„æ–‡ä»¶
   */
  static async save(options: CustomRequestOptions) {
    try {
      await DB.add(DBTable.BackgroundImages, options.file)
      CustomBackgroundImage.images.push(options.file)
      options.onFinish()
    } catch (err) {
      options.onError()
      throw err
    }
  }

  /**
   * å°†å›¾ç‰‡è½¬æ¢ä¸ºæŒ‡å®šé«˜åº¦å¹¶ä¿æŒå®½é«˜æ¯”çš„Blobæ ¼å¼çš„URLå’Œbase64æ•°æ®ã€‚
   * @description created by ChatGPT ğŸ˜Š
   * @param image å›¾ç‰‡ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ç±»å‹çš„å›¾ç‰‡åœ°å€æˆ–Fileç±»å‹çš„å›¾ç‰‡ã€‚
   * @param targetHeight ç›®æ ‡é«˜åº¦ï¼Œå¯é€‰å‚æ•°ã€‚å¦‚æœæä¾›äº†ç›®æ ‡é«˜åº¦ï¼Œåˆ™ä¼šæ ¹æ®ç›®æ ‡é«˜åº¦è°ƒæ•´å›¾ç‰‡å¤§å°å¹¶ä¿æŒå®½é«˜æ¯”ã€‚
   * @param toBase64 æ˜¯å¦ç”Ÿæˆ Base64 æ•°æ®
   * @returns åŒ…å«Blobæ ¼å¼çš„URLå’Œbase64æ•°æ®çš„Promiseã€‚
   */
  static convertImage(image: string | File, targetHeight: number = 200, toBase64: boolean = true): Promise<{ url: string, base64: string }> {
    let imageUrl: string;
  
    if (typeof image === 'string') {
      imageUrl = image;
    } else if (image instanceof File) {
      imageUrl = URL.createObjectURL(image);
    } else {
      throw new Error('Invalid image parameter');
    }
  
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = () => {
        let canvas: HTMLCanvasElement | null = null;
        if (targetHeight) {
          const aspectRatio = img.width / img.height;
          const targetWidth = targetHeight * aspectRatio;
  
          canvas = document.createElement('canvas');
          canvas.width = targetWidth;
          canvas.height = targetHeight;
  
          const ctx = canvas.getContext('2d');
          ctx?.drawImage(img, 0, 0, targetWidth, targetHeight);
        }
  
        if (canvas) {
          canvas.toBlob((blob) => {
            if (blob) {
              const url = URL.createObjectURL(blob);
              if (toBase64) {
                const reader = new FileReader();
                reader.onloadend = () => {
                  resolve({
                    url: url,
                    base64: reader.result as string
                  });
                };
                reader.readAsDataURL(blob);
              } else {
                resolve({ url, base64: '' })
              }
            } else {
              reject(new Error('Failed to create Blob.'));
            }
          });
        } else {
          if (toBase64) {
            const reader = new FileReader();
            reader.onloadend = () => {
              resolve({
                url: imageUrl,
                base64: reader.result as string
              });
            };
            reader.readAsDataURL(image instanceof File ? image : new Blob([img.src]));
          } else {
            resolve({ url: imageUrl, base64: '' })
          }
        }
      };
  
      img.onerror = (error) => {
        reject(error);
      };
  
      img.src = imageUrl;
    });
  }

  /**
   * å°†Base64æ ¼å¼çš„å›¾ç‰‡æ•°æ®è½¬æ¢ä¸ºBlob URLã€‚
   * @param base64Data Base64æ ¼å¼çš„å›¾ç‰‡æ•°æ®ã€‚
   * @returns Blob URLã€‚
   */
  static async base64ToBlobUrl(base64Data: string): Promise<string> {
    const response = await fetch(base64Data);
    const blob = await response.blob();
    const blobUrl = URL.createObjectURL(blob);
    return blobUrl;
  }

  static images = reactive<Array<CustomBackgroundImage>>([])

  static async getImages() {
    if (CustomBackgroundImage.images.length) return CustomBackgroundImage.images
    console.time('è·å–æ‰€æœ‰èƒŒæ™¯å›¾ç‰‡')
    // 1. è¯»å–ä»¥ä¿å­˜çš„æ‰€æœ‰èƒŒæ™¯å›¾ç‰‡
    // console.time('GM_getValue("CustomBackgroundImage")')
    const _images = (await DB.getList<CustomBackgroundImage>(DBTable.BackgroundImages)).map(img => new CustomBackgroundImage(img))
    Object.assign(CustomBackgroundImage.images, _images)
    // console.timeEnd('GM_getValue("CustomBackgroundImage")')
    // 2. æ ¹æ®åŸå›¾ File ç”Ÿæˆç¼©ç•¥å›¾, å¹¶åˆ›å»ºåŸå›¾å’Œç¼©ç•¥å›¾çš„ Blob URL
    for (const img of CustomBackgroundImage.images) {
      if (img.url) continue // http* é“¾æ¥æ ¼å¼çš„å›¾ç‰‡
      img.status = 'pending'
      img.url = URL.createObjectURL(img.file as File)
      const { url } = await CustomBackgroundImage.convertImage(img.file as File, void 0, false)
      img.thumbnailUrl = url
      img.status = 'finished'
      console.log(url)
    }
    console.timeEnd('è·å–æ‰€æœ‰èƒŒæ™¯å›¾ç‰‡')
    return CustomBackgroundImage.images
  }
  static async remove(file: SettledFileInfo) {
    await DB.delete(DBTable.BackgroundImages, file.id)
    const index = CustomBackgroundImage.images.findIndex(img => img.id === file.id)
    CustomBackgroundImage.images.splice(index, 1)
  }
}
